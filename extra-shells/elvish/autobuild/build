export GOPATH="$SRCDIR/abgopath"

# The following command is partitially adopted from Arch Linux's PKGBUILD
# Reference: https://github.com/archlinux/svntogit-community/blob/packages/elvish/trunk/PKGBUILD
abinfo "Fetching Go modules ..."
go mod download

abinfo "Initiating building process ..."
mkdir -vp abbuild
go build -v \
    -ldflags "-linkmode external \
    -X src.elv.sh/pkg/buildinfo.BuildVariant=AOSCOS \
    -X github.com/elves/elvish/pkg/buildinfo.Reproducible=true \
    -X github.com/elves/elvish/pkg/buildinfo.Version=$PKGVER" \
    -o abbuild \
    ./cmd/elvish

abinfo "Installing files ..."
install -Dvm755 -t "$PKGDIR"/usr/bin "$SRCDIR"/abbuild/elvish
install -Dvm644 -t "$PKGDIR"/usr/share/doc/"$PKGNAME" \
    "$SRCDIR"/{README,SECURITY}.md

abinfo "Installing documentations ..."
mkdir -vp "$PKGDIR"/usr/share/doc/website
cp -rv -t "$PKGDIR"/usr/share/doc/website \
    "$SRCDIR"/website/{home.md,README.md,blog,learn,ref,ttyshot,get}
